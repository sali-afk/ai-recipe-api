# 实施计划

- [x] 1. 搭建后端FastAPI项目结构

  - 创建项目目录结构（app/models, app/services, app/api）
  - 配置requirements.txt包含FastAPI、Uvicorn、Pydantic、transformers、torch、Pillow、httpx
  - 创建main.py作为应用入口点
  - 配置CORS中间件和错误处理中间件
  - _需求: 4.1, 4.3_

- [-] 2. 实现后端数据模型


  - [x] 2.1 创建Pydantic请求和响应模型



    - 实现TextQueryRequest、ImageUploadRequest模型
    - 实现Recipe、Ingredient、CookingStep模型
    - 实现APIResponse通用响应模型
    - _需求: 5.1, 5.2, 5.3_
  
  - [ ]* 2.2 编写属性测试验证数据模型
    - **属性 7: 菜谱数据序列化往返**
    - **验证: 需求 3.3**
  
  - [ ]* 2.3 编写单元测试验证模型验证逻辑
    - 测试请求模型的字段验证
    - 测试响应模型的序列化
    - _需求: 5.1, 5.2_

- [ ] 3. 集成通义千问视觉API
  - [x] 3.1 实现QwenVisionClient类





    - 创建异步HTTP客户端调用通义千问API
    - 实现图片Base64编码
    - 实现recognize_image和analyze_ingredients方法
    - 处理API调用错误和重试逻辑
    - _需求: 2.3, 2.4_
  
  - [ ]* 3.2 编写属性测试验证API集成
    - **属性 5: 图片识别API调用**
    - **验证: 需求 2.3, 2.4**
  
  - [ ]* 3.3 编写单元测试验证错误处理
    - 测试API调用失败的错误处理
    - 测试图片编码功能
    - _需求: 2.5_

- [ ] 4. 集成ChefTransformer模型
  - [ ] 4.1 实现ChefTransformerService类
    - 在应用启动时加载ChefTransformer模型
    - 实现generate_recipe方法
    - 实现菜谱内容格式化为中文
    - 添加模型推理缓存机制
    - _需求: 3.1, 3.2, 3.3_
  
  - [ ]* 4.2 编写属性测试验证菜谱生成
    - **属性 6: 菜谱生成完整性**
    - **验证: 需求 3.1, 3.2**
  
  - [ ]* 4.3 编写单元测试验证模型加载
    - 测试模型加载成功
    - 测试缓存机制
    - _需求: 4.2_

- [ ] 5. 实现FastAPI路由端点
  - [x] 5.1 实现文本查询端点 POST /api/chat/text

    - 接收TextQueryRequest
    - 调用ChefTransformerService生成菜谱
    - 返回统一格式的APIResponse
    - _需求: 5.1, 5.3_
  
  - [x] 5.2 实现图片上传端点 POST /api/chat/image





    - 接收multipart/form-data图片文件
    - 调用QwenVisionClient识别图片
    - 基于识别结果调用ChefTransformerService
    - 返回统一格式的APIResponse
    - _需求: 5.2, 5.3_
  
  - [x] 5.3 实现健康检查端点 GET /api/health




    - 检查服务运行状态
    - 检查模型加载状态
    - 返回健康状态信息
    - _需求: 8.5_
  
  - [ ]* 5.4 编写属性测试验证API契约
    - **属性 10: 文本查询API契约**
    - **验证: 需求 5.1**
  
  - [ ]* 5.5 编写属性测试验证图片上传API
    - **属性 11: 图片上传API契约**
    - **验证: 需求 5.2**
  
  - [ ]* 5.6 编写属性测试验证响应格式
    - **属性 9: API响应格式一致性**
    - **验证: 需求 5.3**

- [ ] 6. 实现后端错误处理和验证
  - [x] 6.1 实现全局异常处理器





    - 处理RequestValidationError返回422
    - 处理通用异常返回500
    - 所有错误响应包含中文错误描述
    - _需求: 5.4_
  
  - [x] 6.2 实现请求验证和路由逻辑





    - 验证请求格式
    - 路由到相应的处理函数
    - _需求: 4.4_
  
  - [ ]* 6.3 编写属性测试验证请求处理
    - **属性 8: API请求验证和路由**
    - **验证: 需求 4.4**

- [ ] 7. 实现并发和性能优化
  - [x] 7.1 配置异步处理机制





    - 使用async/await处理所有IO操作
    - 配置连接池管理外部API调用
    - 实现请求队列和并发限制
    - _需求: 8.1_
  
  - [ ]* 7.2 编写属性测试验证并发处理
    - **属性 14: 并发请求处理**
    - **验证: 需求 8.1**
  
  - [ ]* 7.3 编写性能测试
    - 测试响应时间符合要求
    - 测试并发处理能力
    - _需求: 8.2_

- [ ] 8. 创建Docker容器配置
  - [x] 8.1 编写Dockerfile





    - 使用Python 3.10基础镜像
    - 安装系统依赖和Python依赖
    - 预下载ChefTransformer模型
    - 配置启动命令
    - _需求: 4.1_
  
  - [x] 8.2 编写docker-compose.yml





    - 配置API服务
    - 配置Nginx反向代理
    - 配置环境变量和卷挂载
    - 配置健康检查
    - _需求: 4.3_
  
  - [ ] 8.3 编写Nginx配置文件
    - 配置HTTPS和HTTP重定向
    - 配置反向代理到FastAPI
    - 配置请求大小限制
    - _需求: 5.5_

- [ ] 9. 检查点 - 确保后端所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 10. 搭建iOS SwiftUI项目结构
  - [ ] 10.1 创建新的iOS项目
    - 使用SwiftUI生命周期
    - 配置最低iOS版本为15.0
    - 创建项目目录结构（Views, ViewModels, Models, Services）
    - _需求: 1.1_
  
  - [ ] 10.2 配置项目依赖
    - 添加必要的Swift包（如果需要）
    - 配置Info.plist权限（相册、相机访问）
    - _需求: 2.1_

- [ ] 11. 实现iOS数据模型
  - [ ] 11.1 创建Message模型
    - 定义Message结构体，包含id、content、isUser、timestamp、imageData、recipeData
    - 实现Codable协议
    - _需求: 1.2, 1.3_
  
  - [ ] 11.2 创建RecipeData模型
    - 定义RecipeData、Ingredient、CookingStep结构体
    - 实现Codable协议
    - _需求: 3.4_
  
  - [ ] 11.3 创建APIResponse模型
    - 定义泛型APIResponse结构体
    - 实现Codable协议
    - _需求: 5.3_

- [ ] 12. 实现iOS网络服务层
  - [ ] 12.1 创建APIService类
    - 实现sendTextQuery方法
    - 实现uploadImage方法
    - 实现checkHealth方法
    - 配置URLSession和请求超时
    - _需求: 1.2, 2.2_
  
  - [ ] 12.2 实现错误处理
    - 定义APIError枚举
    - 处理网络错误、超时、解析错误
    - 实现重试逻辑
    - _需求: 6.1, 6.2, 6.3_
  
  - [ ]* 12.3 编写属性测试验证错误解析
    - **属性 12: 错误响应解析**
    - **验证: 需求 6.3**
  
  - [ ]* 12.4 编写单元测试验证网络服务
    - 测试请求构建
    - 测试响应解析
    - 测试错误处理
    - _需求: 6.1, 6.2_

- [ ] 13. 实现ChatViewModel
  - [ ] 13.1 创建ChatViewModel类
    - 使用@Published属性管理messages、isLoading、errorMessage
    - 实现sendTextMessage方法
    - 实现sendImageMessage方法
    - 处理API响应并更新消息列表
    - _需求: 1.2, 1.3, 2.2_
  
  - [ ]* 13.2 编写属性测试验证消息处理
    - **属性 1: 消息发送和显示一致性**
    - **验证: 需求 1.2**
  
  - [ ]* 13.3 编写属性测试验证响应处理
    - **属性 2: API响应处理完整性**
    - **验证: 需求 1.3**
  
  - [ ]* 13.4 编写单元测试验证状态管理
    - 测试消息列表更新
    - 测试加载状态管理
    - 测试错误状态管理
    - _需求: 1.2, 1.3_

- [ ] 14. 实现ChatView界面
  - [ ] 14.1 创建消息列表视图
    - 使用ScrollView和LazyVStack显示消息
    - 实现自动滚动到最新消息
    - 区分用户消息和AI消息的视觉样式
    - _需求: 1.1, 7.2_
  
  - [ ] 14.2 创建消息气泡组件
    - 实现MessageBubbleView
    - 根据isUser属性应用不同样式
    - 支持文本和图片显示
    - _需求: 7.2_
  
  - [ ] 14.3 创建输入区域
    - 实现文本输入框
    - 实现发送按钮
    - 实现图片上传按钮
    - _需求: 1.1, 2.1_
  
  - [ ]* 14.4 编写属性测试验证视觉区分
    - **属性 13: 消息类型视觉区分**
    - **验证: 需求 7.2**

- [ ] 15. 实现图片选择功能
  - [ ] 15.1 集成PhotosPicker或UIImagePickerController
    - 实现图片选择器
    - 处理图片选择回调
    - 实现图片压缩
    - _需求: 2.1, 2.2_
  
  - [ ]* 15.2 编写属性测试验证图片上传
    - **属性 4: 图片上传触发**
    - **验证: 需求 2.2**
  
  - [ ]* 15.3 编写单元测试验证图片处理
    - 测试图片压缩
    - 测试图片数据转换
    - _需求: 2.2_

- [ ] 16. 实现菜谱显示视图
  - [ ] 16.1 创建RecipeView组件
    - 显示菜品名称
    - 显示食材列表
    - 显示烹饪步骤
    - 显示时间和难度
    - 支持滚动浏览
    - _需求: 3.4, 3.5_
  
  - [ ]* 16.2 编写单元测试验证菜谱显示
    - 测试菜谱数据渲染
    - 测试滚动功能
    - _需求: 3.4, 3.5_

- [ ] 17. 实现中文内容格式化
  - [ ] 17.1 确保所有文本使用UTF-8编码
    - 配置网络请求编码
    - 配置UI文本显示
    - _需求: 1.4_
  
  - [ ]* 17.2 编写属性测试验证中文格式化
    - **属性 3: 中文内容格式化**
    - **验证: 需求 1.4**

- [ ] 18. 实现UI主题适配
  - [ ] 18.1 配置深色和浅色主题
    - 使用SwiftUI的Color.primary等系统颜色
    - 配置自定义颜色支持主题切换
    - 测试主题切换效果
    - _需求: 7.4_

- [ ] 19. 实现错误提示和加载状态UI
  - [ ] 19.1 创建错误提示视图
    - 显示错误消息
    - 提供重试按钮
    - 自动消失或手动关闭
    - _需求: 6.1, 6.2, 6.3_
  
  - [ ] 19.2 创建加载指示器
    - 显示加载动画
    - 防止重复提交
    - _需求: 1.2, 2.2_
  
  - [ ] 19.3 实现离线状态检测
    - 检测网络连接状态
    - 显示离线提示
    - 禁用发送功能
    - _需求: 6.5_

- [ ] 20. 检查点 - 确保iOS所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 21. 端到端集成测试
  - [ ]* 21.1 编写完整流程集成测试
    - 测试文本查询完整流程
    - 测试图片上传和识别流程
    - 测试菜谱生成和显示流程
    - _需求: 1.2, 1.3, 2.2, 2.3, 2.4, 3.1, 3.2, 3.4_
  
  - [ ]* 21.2 测试Docker容器部署
    - 测试容器构建
    - 测试容器启动和健康检查
    - 测试容器重启恢复
    - _需求: 4.2, 4.3, 8.4_

- [ ] 22. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
